# Fix: Overrides and Team Tabs in Agent Detail Modal

## Problem Summary
After fixing the policies/commissions tabs, the **Overrides** and **Team Comparison** tabs in the Agent Detail Modal still don't show data when an upline views a downline.

## Root Cause Analysis

### Issue 1: Missing RLS Policy for Upline Visibility of Downline Profiles

**Current `user_profiles` RLS policies:**
1. `user_profiles_select_own` - View own profile only
2. `user_profiles_select_own_upline` - View YOUR upline's profile
3. `user_profiles_select_own_recruiter` - View your recruiter's profile

**Missing:** Policy for uplines to view their downlines' profiles

**Impact:**
- `getTeamComparison` fails at step 1: Can't get downline's `hierarchy_depth`
- Any query that needs to read downline's user_profile data fails

### Issue 2: Override Commissions RLS May Be Working But Needs Verification

The new RLS policy uses `is_upline_of(base_agent_id)` which should allow uplines to see overrides generated by their downlines. However:
- Need to verify `hierarchy_path` format matches what `is_upline_of` expects
- The function checks: `hierarchy_path LIKE '%' || auth.uid()::text || '%'`

### Issue 3: Team Comparison Design Flaw

`getTeamComparison` queries ALL agents at the same `hierarchy_depth` across the entire organization, not just within the upline's team. This is problematic:
1. It requires visibility to ALL user_profiles at that level (not achievable with proper RLS)
2. It's comparing apples to oranges (agents from different teams/branches)

## Solution Plan

### Step 1: Add RLS Policy for Uplines to View Downline Profiles

Create a new policy on `user_profiles` that allows uplines to view their downlines:

```sql
-- Using hierarchy_path: upline is in downline's path
CREATE POLICY "Uplines can view downline profiles"
ON user_profiles FOR SELECT
TO authenticated
USING (
  hierarchy_path IS NOT NULL
  AND hierarchy_path LIKE (
    SELECT hierarchy_path || '.%'
    FROM user_profiles
    WHERE id = auth.uid()
  )
);
```

**Problem:** This creates RLS recursion (querying user_profiles inside user_profiles policy).

**Solution:** Use SECURITY DEFINER function like the existing `get_user_upline_and_recruiter_ids`:

```sql
CREATE OR REPLACE FUNCTION get_current_user_hierarchy_path()
RETURNS text
LANGUAGE sql
SECURITY DEFINER
SET search_path = public
STABLE
AS $$
  SELECT hierarchy_path FROM user_profiles WHERE id = auth.uid();
$$;

CREATE POLICY "Uplines can view downline profiles"
ON user_profiles FOR SELECT
TO authenticated
USING (
  hierarchy_path IS NOT NULL
  AND hierarchy_path LIKE get_current_user_hierarchy_path() || '.%'
);
```

### Step 2: Fix Team Comparison to Use Team-Scoped Data

Modify `getTeamComparison` to:
1. Compare agent against their TEAM peers (same upline) not the entire organization
2. Or compare against the upline's entire downline tree

**Option A: Compare against siblings (same parent):**
```typescript
// Get siblings = agents with same upline_id
const { data: peers } = await supabase
  .from("user_profiles")
  .select("id, email")
  .eq("upline_id", agent.upline_id);  // Same parent
```

**Option B: Compare against team (all downlines of the viewing upline):**
```typescript
// Compare within the viewer's team
const currentUser = await supabase.auth.getUser();
const { data: teamMembers } = await supabase
  .from("user_profiles")
  .select("*")
  .like("hierarchy_path", `${viewerHierarchyPath}.%`);
```

### Step 3: Verify Override Commissions Work

After Step 1, the override queries should work because:
1. `is_upline_of(base_agent_id)` checks if current user is in base_agent's hierarchy_path
2. This requires reading base_agent's user_profile (now allowed by Step 1)

## Implementation Order

1. **Migration: Add upline-can-view-downlines RLS on user_profiles**
2. **Test: Verify overrides tab now works**
3. **Code: Fix getTeamComparison to use team-scoped comparison**
4. **Test: Verify team comparison tab now works**

## Files to Modify

| File | Change |
|------|--------|
| `supabase/migrations/20251219_004_upline_view_downline_profiles.sql` | New migration |
| `src/services/hierarchy/hierarchyService.ts` | Fix `getTeamComparison` method |

## Risks

1. **RLS Recursion:** Must use SECURITY DEFINER function to avoid recursion
2. **Performance:** Adding LIKE pattern matching on hierarchy_path may need indexing
3. **Scope Change:** Team comparison will show different data (team-scoped vs org-wide)

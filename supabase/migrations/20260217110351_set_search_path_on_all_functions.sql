-- Fix function_search_path_mutable security warnings.
-- Sets search_path = public on all 205 application functions that are missing it.
-- This prevents search-path hijacking where a caller could manipulate the search
-- path to resolve unqualified table/function names from a malicious schema.
-- Extension functions (pg_trgm, pg_net) are intentionally excluded.
--
-- Uses ALTER FUNCTION (not CREATE OR REPLACE) so function bodies are untouched.

BEGIN;

ALTER FUNCTION public.add_to_read_by(message_id uuid, user_id uuid) SET search_path = public;
ALTER FUNCTION public.admin_approve_user(target_user_id uuid, approver_id uuid) SET search_path = public;
ALTER FUNCTION public.admin_deleteuser(target_user_id uuid) SET search_path = public;
ALTER FUNCTION public.admin_deny_user(target_user_id uuid, approver_id uuid, reason text) SET search_path = public;
ALTER FUNCTION public.admin_set_admin_role(target_user_id uuid, new_is_admin boolean) SET search_path = public;
ALTER FUNCTION public.admin_set_pending_user(target_user_id uuid) SET search_path = public;
ALTER FUNCTION public.admin_update_domain_status(p_domain_id uuid, p_user_id uuid, p_new_status custom_domain_status, p_verified_at timestamp with time zone, p_provider_domain_id text, p_provider_metadata jsonb, p_last_error text) SET search_path = public;
ALTER FUNCTION public.auto_cancel_stale_invitations() SET search_path = public;
ALTER FUNCTION public.auto_create_commission_record() SET search_path = public;
ALTER FUNCTION public.auto_create_decision_tree_for_new_imo() SET search_path = public;
ALTER FUNCTION public.calculate_chargeback_on_policy_lapse(p_policy_id uuid, p_lapse_date date) SET search_path = public;
ALTER FUNCTION public.calculate_commission_advance(p_annual_premium numeric, p_commission_percentage numeric, p_advance_months integer, p_contract_level numeric) SET search_path = public;
ALTER FUNCTION public.calculate_earned_amount(p_amount numeric, p_advance_months integer, p_months_paid integer) SET search_path = public;
ALTER FUNCTION public.calculate_months_paid(p_effective_date date, p_end_date date) SET search_path = public;
ALTER FUNCTION public.calculate_next_delivery(p_frequency report_frequency, p_day_of_week smallint, p_day_of_month smallint, p_preferred_time time without time zone, p_from_date timestamp with time zone) SET search_path = public;
ALTER FUNCTION public.calculate_quiz_score(p_answers jsonb, p_questions jsonb) SET search_path = public;
ALTER FUNCTION public.calculate_unearned_amount(p_amount numeric, p_advance_months integer, p_months_paid integer) SET search_path = public;
ALTER FUNCTION public.can_run_uw_wizard(p_user_id uuid) SET search_path = public;
ALTER FUNCTION public.can_view_agent_details(p_agent_id uuid) SET search_path = public;
ALTER FUNCTION public.can_workflow_run(p_workflow_id uuid, p_recipient_id uuid) SET search_path = public;
ALTER FUNCTION public.cancel_recruit_invitation(p_invitation_id uuid) SET search_path = public;
ALTER FUNCTION public.cascade_hierarchy_path_changes() SET search_path = public;
ALTER FUNCTION public.check_auth_identity(check_email text) SET search_path = public;
ALTER FUNCTION public.check_email_exists(target_email text) SET search_path = public;
ALTER FUNCTION public.check_email_quota(p_user_id uuid, p_provider text, p_limit integer) SET search_path = public;
ALTER FUNCTION public.check_no_circular_reference() SET search_path = public;
ALTER FUNCTION public.check_pending_invitation_exists(p_email text, p_inviter_id uuid) SET search_path = public;
ALTER FUNCTION public.check_user_template_limit(user_uuid uuid) SET search_path = public;
ALTER FUNCTION public.check_workflow_email_rate_limit(p_user_id uuid, p_workflow_id uuid, p_recipient_email text, p_recipient_count integer) SET search_path = public;
ALTER FUNCTION public.claim_instagram_jobs(p_job_types instagram_job_type[], p_limit integer) SET search_path = public;
ALTER FUNCTION public.cleanup_expired_invitations() SET search_path = public;
ALTER FUNCTION public.cleanup_instagram_jobs(p_older_than interval) SET search_path = public;
ALTER FUNCTION public.cleanup_old_reports(max_reports_per_user integer) SET search_path = public;
ALTER FUNCTION public.complete_instagram_job(p_job_id uuid, p_result jsonb) SET search_path = public;
ALTER FUNCTION public.complete_scheduled_delivery(p_schedule_id uuid, p_delivery_id uuid, p_success boolean, p_error_message text, p_mailgun_message_id text) SET search_path = public;
ALTER FUNCTION public.create_as_earned_commission() SET search_path = public;
ALTER FUNCTION public.create_capped_overage_commission() SET search_path = public;
ALTER FUNCTION public.create_onboarding_phases_for_recruit() SET search_path = public;
ALTER FUNCTION public.create_override_commissions() SET search_path = public;
ALTER FUNCTION public.create_recruit_invitation(p_recruit_id uuid, p_email text, p_message text) SET search_path = public;
ALTER FUNCTION public.create_scheduled_report(p_schedule_name text, p_report_type text, p_frequency report_frequency, p_day_of_week smallint, p_day_of_month smallint, p_preferred_time time without time zone, p_recipients jsonb, p_export_format text, p_report_config jsonb, p_include_charts boolean, p_include_insights boolean, p_include_summary boolean) SET search_path = public;
ALTER FUNCTION public.delete_orphan_identity(del_email text) SET search_path = public;
ALTER FUNCTION public.delete_recruit(target_recruit_id uuid) SET search_path = public;
ALTER FUNCTION public.duplicate_training_lesson(p_lesson_id uuid) SET search_path = public;
ALTER FUNCTION public.email_subject_hash(subject text) SET search_path = public;
ALTER FUNCTION public.enqueue_instagram_job(p_job_type instagram_job_type, p_payload jsonb, p_integration_id uuid, p_priority integer, p_scheduled_for timestamp with time zone) SET search_path = public;
ALTER FUNCTION public.ensure_single_default_template() SET search_path = public;
ALTER FUNCTION public.ensure_system_labels(p_user_id uuid) SET search_path = public;
ALTER FUNCTION public.ensure_valid_contract_level() SET search_path = public;
ALTER FUNCTION public.fail_instagram_job(p_job_id uuid, p_error text) SET search_path = public;
ALTER FUNCTION public.forum_markdown_to_plain(p_markdown text) SET search_path = public;
ALTER FUNCTION public.forum_set_faq_derived_fields() SET search_path = public;
ALTER FUNCTION public.forum_set_post_derived_fields() SET search_path = public;
ALTER FUNCTION public.forum_set_topic_derived_fields() SET search_path = public;
ALTER FUNCTION public.forum_set_updated_at() SET search_path = public;
ALTER FUNCTION public.forum_validate_topic_post_refs() SET search_path = public;
ALTER FUNCTION public.get_active_decision_tree(p_imo_id uuid) SET search_path = public;
ALTER FUNCTION public.get_agent_contract_summary(p_agent_id uuid) SET search_path = public;
ALTER FUNCTION public.get_at_risk_commissions(p_user_id uuid, p_risk_threshold integer) SET search_path = public;
ALTER FUNCTION public.get_available_knockout_codes() SET search_path = public;
ALTER FUNCTION public.get_carrier_acceptance(p_carrier_id uuid, p_condition_code text, p_product_type text, p_imo_id uuid) SET search_path = public;
ALTER FUNCTION public.get_current_user_profile_id() SET search_path = public;
ALTER FUNCTION public.get_daily_production_by_agent(p_imo_id uuid, p_agency_id uuid) SET search_path = public;
ALTER FUNCTION public.get_downline_with_emails(p_user_id uuid, p_max_count integer) SET search_path = public;
ALTER FUNCTION public.get_due_scheduled_reports() SET search_path = public;
ALTER FUNCTION public.get_eligible_recipients(p_imo_id uuid, p_agency_id uuid) SET search_path = public;
ALTER FUNCTION public.get_imo_contract_stats(p_imo_id uuid) SET search_path = public;
ALTER FUNCTION public.get_knockout_conditions() SET search_path = public;
ALTER FUNCTION public.get_message_stats(p_user_id uuid) SET search_path = public;
ALTER FUNCTION public.get_my_scheduled_reports() SET search_path = public;
ALTER FUNCTION public.get_pending_invitations_count() SET search_path = public;
ALTER FUNCTION public.get_pipeline_template_for_user(p_agent_status agent_status, p_roles text[]) SET search_path = public;
ALTER FUNCTION public.get_policies_paginated(p_cursor timestamp with time zone, p_limit integer, p_status text, p_carrier_id uuid, p_product_id uuid, p_user_id uuid) SET search_path = public;
ALTER FUNCTION public.get_policy_count(p_status text, p_carrier_id uuid, p_product_id uuid, p_user_id uuid) SET search_path = public;
ALTER FUNCTION public.get_product_commission_rate(p_product_id uuid, p_comp_level comp_level, p_date date) SET search_path = public;
ALTER FUNCTION public.get_product_rate(p_product_id uuid, p_age integer, p_gender text, p_tobacco_class text, p_health_class text, p_imo_id uuid) SET search_path = public;
ALTER FUNCTION public.get_role_permissions_with_inheritance(p_role_id uuid) SET search_path = public;
ALTER FUNCTION public.get_schedule_delivery_history(p_schedule_id uuid, p_limit integer) SET search_path = public;
ALTER FUNCTION public.get_sync_webhook_secret() SET search_path = public;
ALTER FUNCTION public.get_upline_chain(p_user_id uuid, p_max_depth integer) SET search_path = public;
ALTER FUNCTION public.get_user_addons(p_user_id uuid) SET search_path = public;
ALTER FUNCTION public.get_user_commission_profile(p_user_id uuid, p_lookback_months integer) SET search_path = public;
ALTER FUNCTION public.get_user_permissions(target_user_id uuid) SET search_path = public;
ALTER FUNCTION public.get_user_profile(user_id uuid) SET search_path = public;
ALTER FUNCTION public.get_uw_wizard_usage(p_user_id uuid) SET search_path = public;
ALTER FUNCTION public.get_vendors_with_stats(p_imo_id uuid, p_include_inactive boolean) SET search_path = public;
ALTER FUNCTION public.get_workflow_email_usage(p_user_id uuid) SET search_path = public;
ALTER FUNCTION public.getuser_commission_profile(puser_id uuid, p_lookback_months integer) SET search_path = public;
ALTER FUNCTION public.hard_delete_user(p_user_id uuid, p_deleted_by uuid, p_confirm_text text) SET search_path = public;
ALTER FUNCTION public.has_role(role_to_check text) SET search_path = public;
ALTER FUNCTION public.health_class_rank(hc health_class) SET search_path = public;
ALTER FUNCTION public.hierarchy_path_array(path text) SET search_path = public;
ALTER FUNCTION public.increment_email_quota(p_user_id uuid, p_provider text) SET search_path = public;
ALTER FUNCTION public.increment_uw_wizard_usage(p_user_id uuid, p_imo_id uuid, p_session_id uuid, p_input_tokens integer, p_output_tokens integer) SET search_path = public;
ALTER FUNCTION public.is_admin_user() SET search_path = public;
ALTER FUNCTION public.is_caller_admin() SET search_path = public;
ALTER FUNCTION public.is_contact_favorited(p_user_id uuid, p_contact_user_id uuid, p_client_id uuid) SET search_path = public;
ALTER FUNCTION public.is_elevenlabs_available(p_imo_id uuid) SET search_path = public;
ALTER FUNCTION public.is_staff_role() SET search_path = public;
ALTER FUNCTION public.is_training_hub_staff(user_id uuid) SET search_path = public;
ALTER FUNCTION public.is_underwriting_wizard_enabled(p_agency_id uuid) SET search_path = public;
ALTER FUNCTION public.is_upline_of(target_user_id uuid) SET search_path = public;
ALTER FUNCTION public.log_document_changes() SET search_path = public;
ALTER FUNCTION public.log_email_events() SET search_path = public;
ALTER FUNCTION public.log_user_profile_changes() SET search_path = public;
ALTER FUNCTION public.log_uw_wizard_access_change() SET search_path = public;
ALTER FUNCTION public.log_writing_number_changes() SET search_path = public;
ALTER FUNCTION public.mark_invitation_sent(p_invitation_id uuid) SET search_path = public;
ALTER FUNCTION public.mark_policy_cancelled(p_policy_id uuid, p_cancellation_date date, p_cancellation_reason text) SET search_path = public;
ALTER FUNCTION public.mark_policy_lapsed(p_policy_id uuid, p_lapse_date date, p_lapse_reason text) SET search_path = public;
ALTER FUNCTION public.mark_thread_read(p_thread_id uuid) SET search_path = public;
ALTER FUNCTION public.merge_vendors(p_keep_vendor_id uuid, p_merge_vendor_ids uuid[]) SET search_path = public;
ALTER FUNCTION public.normalize_custom_domain_hostname() SET search_path = public;
ALTER FUNCTION public.normalize_email_subject(subject text) SET search_path = public;
ALTER FUNCTION public.notify_client_webhook() SET search_path = public;
ALTER FUNCTION public.notify_policy_webhook() SET search_path = public;
ALTER FUNCTION public.notify_user_profile_webhook() SET search_path = public;
ALTER FUNCTION public.on_policy_created() SET search_path = public;
ALTER FUNCTION public.populate_phase_progress_imo_id() SET search_path = public;
ALTER FUNCTION public.prevent_system_role_permission_changes() SET search_path = public;
ALTER FUNCTION public.process_workflow_trigger(p_event_name text, p_context jsonb) SET search_path = public;
ALTER FUNCTION public.propagate_months_paid_to_overrides() SET search_path = public;
ALTER FUNCTION public.rank_to_health_class(rank integer) SET search_path = public;
ALTER FUNCTION public.record_email_click(p_link_tracking_id uuid, p_ip_address inet, p_user_agent text, p_device_type text, p_country text, p_city text) SET search_path = public;
ALTER FUNCTION public.record_email_open(p_tracking_id uuid, p_ip_address inet, p_user_agent text, p_device_type text, p_country text, p_city text) SET search_path = public;
ALTER FUNCTION public.record_workflow_email(p_workflow_id uuid, p_user_id uuid, p_recipient_email text, p_recipient_type text, p_success boolean, p_error_message text) SET search_path = public;
ALTER FUNCTION public.refresh_all_report_materialized_views() SET search_path = public;
ALTER FUNCTION public.regenerate_override_commissions(p_policy_id uuid) SET search_path = public;
ALTER FUNCTION public.resend_recruit_invitation(p_invitation_id uuid) SET search_path = public;
ALTER FUNCTION public.safe_uuid_from_text(input text) SET search_path = public;
ALTER FUNCTION public.set_default_decision_tree(p_tree_id uuid, p_imo_id uuid) SET search_path = public;
ALTER FUNCTION public.set_hierarchy_path_on_insert() SET search_path = public;
ALTER FUNCTION public.set_imo_id_from_user() SET search_path = public;
ALTER FUNCTION public.set_override_commission_agency_id() SET search_path = public;
ALTER FUNCTION public.set_presentation_review_metadata() SET search_path = public;
ALTER FUNCTION public.set_recruiting_progress_org_ids() SET search_path = public;
ALTER FUNCTION public.setup_baltimore_life_apriority_rules(p_carrier_id uuid, p_imo_id uuid, p_user_id uuid) SET search_path = public;
ALTER FUNCTION public.sync_override_commission_status() SET search_path = public;
ALTER FUNCTION public.sync_user_names_from_auth() SET search_path = public;
ALTER FUNCTION public.table_rating_units(rating table_rating) SET search_path = public;
ALTER FUNCTION public.test_rls_for_user(test_user_id uuid) SET search_path = public;
ALTER FUNCTION public.trigger_calculate_next_run() SET search_path = public;
ALTER FUNCTION public.units_to_table_rating(units integer) SET search_path = public;
ALTER FUNCTION public.update_alert_rules_updated_at() SET search_path = public;
ALTER FUNCTION public.update_carrier_build_charts_updated_at() SET search_path = public;
ALTER FUNCTION public.update_carrier_build_tables_updated_at() SET search_path = public;
ALTER FUNCTION public.update_carrier_contracts_updated_at() SET search_path = public;
ALTER FUNCTION public.update_commission_earned_amounts() SET search_path = public;
ALTER FUNCTION public.update_commission_on_policy_status() SET search_path = public;
ALTER FUNCTION public.update_conversation_on_message() SET search_path = public;
ALTER FUNCTION public.update_email_queue_updated_at() SET search_path = public;
ALTER FUNCTION public.update_email_tables_updated_at() SET search_path = public;
ALTER FUNCTION public.update_global_expense_categories_updated_at() SET search_path = public;
ALTER FUNCTION public.update_gmail_integrations_updated_at() SET search_path = public;
ALTER FUNCTION public.update_hierarchy_path() SET search_path = public;
ALTER FUNCTION public.update_hierarchy_path_on_upline_change() SET search_path = public;
ALTER FUNCTION public.update_instagram_conversations_updated_at() SET search_path = public;
ALTER FUNCTION public.update_instagram_integrations_updated_at() SET search_path = public;
ALTER FUNCTION public.update_instagram_scheduled_updated_at() SET search_path = public;
ALTER FUNCTION public.update_instagram_templates_updated_at() SET search_path = public;
ALTER FUNCTION public.update_landing_page_settings_updated_at() SET search_path = public;
ALTER FUNCTION public.update_lead_purchases_updated_at() SET search_path = public;
ALTER FUNCTION public.update_lead_vendors_updated_at() SET search_path = public;
ALTER FUNCTION public.update_message_threads_updated_at() SET search_path = public;
ALTER FUNCTION public.update_messages_updated_at() SET search_path = public;
ALTER FUNCTION public.update_notifications_updated_at() SET search_path = public;
ALTER FUNCTION public.update_onboarding_phases_updated_at() SET search_path = public;
ALTER FUNCTION public.update_override_commission_earned_amounts() SET search_path = public;
ALTER FUNCTION public.update_override_commissions_updated_at() SET search_path = public;
ALTER FUNCTION public.update_own_presentation(p_id uuid, p_title text, p_description text) SET search_path = public;
ALTER FUNCTION public.update_phase_checklist_items_updated_at() SET search_path = public;
ALTER FUNCTION public.update_pipeline_phases_updated_at() SET search_path = public;
ALTER FUNCTION public.update_pipeline_templates_updated_at() SET search_path = public;
ALTER FUNCTION public.update_product_build_tables_updated_at() SET search_path = public;
ALTER FUNCTION public.update_recruit_checklist_progress_updated_at() SET search_path = public;
ALTER FUNCTION public.update_recruit_invitations_updated_at() SET search_path = public;
ALTER FUNCTION public.update_recruit_phase_progress_updated_at() SET search_path = public;
ALTER FUNCTION public.update_recruiting_leads_updated_at() SET search_path = public;
ALTER FUNCTION public.update_scheduled_report(p_schedule_id uuid, p_schedule_name text, p_frequency report_frequency, p_day_of_week smallint, p_day_of_month smallint, p_preferred_time time without time zone, p_recipients jsonb, p_export_format text, p_report_config jsonb, p_include_charts boolean, p_include_insights boolean, p_include_summary boolean, p_is_active boolean) SET search_path = public;
ALTER FUNCTION public.update_scheduled_reports_updated_at() SET search_path = public;
ALTER FUNCTION public.update_scheduling_integrations_updated_at() SET search_path = public;
ALTER FUNCTION public.update_signature_updated_at() SET search_path = public;
ALTER FUNCTION public.update_slack_channel_configs_updated_at() SET search_path = public;
ALTER FUNCTION public.update_slack_integrations_updated_at() SET search_path = public;
ALTER FUNCTION public.update_slack_webhooks_updated_at() SET search_path = public;
ALTER FUNCTION public.update_subscription_addons_updated_at() SET search_path = public;
ALTER FUNCTION public.update_subscription_settings_updated_at() SET search_path = public;
ALTER FUNCTION public.update_subscription_updated_at() SET search_path = public;
ALTER FUNCTION public.update_template_categories_updated_at() SET search_path = public;
ALTER FUNCTION public.update_thread_metadata() SET search_path = public;
ALTER FUNCTION public.update_training_documents_updated_at() SET search_path = public;
ALTER FUNCTION public.update_underwriting_updated_at() SET search_path = public;
ALTER FUNCTION public.update_updated_at_column() SET search_path = public;
ALTER FUNCTION public.update_user_documents_updated_at() SET search_path = public;
ALTER FUNCTION public.update_user_emails_updated_at() SET search_path = public;
ALTER FUNCTION public.update_user_metadata(user_id uuid, metadata jsonb) SET search_path = public;
ALTER FUNCTION public.update_user_slack_preferences_updated_at() SET search_path = public;
ALTER FUNCTION public.update_user_targets_updated_at() SET search_path = public;
ALTER FUNCTION public.update_uw_wizard_usage_updated_at() SET search_path = public;
ALTER FUNCTION public.user_has_uw_wizard_access(p_user_id uuid) SET search_path = public;
ALTER FUNCTION public.validate_field_requirements(p_requirements jsonb) SET search_path = public;
ALTER FUNCTION public.validate_invitation_eligibility(p_inviter_id uuid, p_invitee_email text, p_exclude_invitation_id uuid) SET search_path = public;
ALTER FUNCTION public.validate_report_date_range(p_start_date date, p_end_date date, p_max_months integer) SET search_path = public;
ALTER FUNCTION public.validate_schedule_recipients(p_recipients jsonb, p_imo_id uuid, p_agency_id uuid) SET search_path = public;
ALTER FUNCTION public.validate_social_links_urls(links jsonb) SET search_path = public;

COMMIT;

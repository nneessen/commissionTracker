import React, { useState, useCallback, useRef } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { compGuideService } from '@/services/settings/compGuideService';
import { carrierService } from '@/services/settings/carrierService';
import { productService } from '@/services/settings/productService';
import { useCompRates, useCreateCompRate, useUpdateCompRate } from '@/hooks/comps/useCompRates';
import { Button } from '@/components/ui/Button';
import { Input } from '@/components/ui/Input';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow
} from '@/components/ui/table';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Plus, Trash2, Search, Download, Upload } from 'lucide-react';
import type { Database } from '@/types/database.types';

type ProductType = Database['public']['Enums']['product_type'];

interface CommissionGridRow {
  carrierId: string;
  carrierName: string;
  productId: string | null;
  productName: string;
  productType: ProductType | null;
  isActive: boolean;
  rates: Record<number, number>;
}

interface EditingCell {
  rowId: string;
  contractLevel: number;
  value: string;
}

interface QuickAddForm {
  carrier: string;
  productName: string;
  productType: ProductType;
}

// Contract levels from 80 to 145 in increments of 5
const CONTRACT_LEVELS = Array.from({ length: 14 }, (_, i) => 80 + i * 5);

const PRODUCT_TYPES: ProductType[] = [
  'term_life',
  'whole_life',
  'universal_life',
  'variable_life',
  'health',
  'disability',
  'annuity'
];

export function CommissionManagement() {
  const queryClient = useQueryClient();
  const [searchTerm, setSearchTerm] = useState('');
  const [editingCell, setEditingCell] = useState<EditingCell | null>(null);
  const [showBulkImport, setShowBulkImport] = useState(false);
  const [bulkImportText, setBulkImportText] = useState('');
  const [quickAddForm, setQuickAddForm] = useState<QuickAddForm>({
    carrier: '',
    productName: '',
    productType: 'term_life'
  });

  const inputRef = useRef<HTMLInputElement>(null);

  // Fetch all commission data
  const { data: gridData = [], isLoading, error } = useQuery({
    queryKey: ['commission-grid'],
    queryFn: () => compGuideService.getAllCommissionData(),
  });

  // Get unique carriers for dropdown
  const carriers = Array.from(new Set(gridData.map(row => ({
    id: row.carrierId,
    name: row.carrierName
  })))).reduce((acc, curr) => {
    if (!acc.find(c => c.id === curr.id)) acc.push(curr);
    return acc;
  }, [] as Array<{ id: string; name: string }>);

  // Mutations
  const createCompRate = useCreateCompRate();
  const updateCompRate = useUpdateCompRate();

  // Mutation for creating product under existing carrier
  const createProduct = useMutation({
    mutationFn: async (data: { carrierId: string; productName: string; productType: ProductType }) => {
      return await productService.createProduct({
        carrier_id: data.carrierId,
        name: data.productName,
        product_type: data.productType,
        is_active: true
      });
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['commission-grid'] });
      setQuickAddForm({ carrier: '', productName: '', productType: 'term_life' });
    },
  });

  // Mutation for creating new carrier with product
  const createCarrierWithProduct = useMutation({
    mutationFn: async (data: { carrierName: string; productName: string; productType: ProductType }) => {
      const carrierResponse = await carrierService.createCarrier({
        name: data.carrierName,
        is_active: true
      });

      if (!carrierResponse || !carrierResponse.data) {
        throw new Error('Failed to create carrier');
      }

      const product = await productService.createProduct({
        carrier_id: carrierResponse.data.id,
        name: data.productName,
        product_type: data.productType,
        is_active: true
      });

      return { carrier: carrierResponse.data, product };
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['commission-grid'] });
      setQuickAddForm({ carrier: '', productName: '', productType: 'term_life' });
    },
  });

  // Mutation for bulk import
  const bulkImportMutation = useMutation({
    mutationFn: async (csvText: string) => {
      const lines = csvText.trim().split('\n');
      const results = [];

      for (const line of lines) {
        const [carrierName, productName, productTypeStr] = line.split(',').map(s => s.trim());

        if (!carrierName || !productName) continue;

        const productType = (productTypeStr || 'term_life') as ProductType;

        // Check if carrier exists
        let carrier = carriers.find(c => c.name.toLowerCase() === carrierName.toLowerCase());

        if (!carrier) {
          // Create new carrier
          const carrierResponse = await carrierService.createCarrier({
            name: carrierName,
            is_active: true
          });

          if (carrierResponse?.data) {
            carrier = { id: carrierResponse.data.id, name: carrierResponse.data.name };
          }
        }

        if (carrier) {
          // Create product
          await productService.createProduct({
            carrier_id: carrier.id,
            name: productName,
            product_type: productType,
            is_active: true
          });
          results.push({ carrierName, productName, success: true });
        }
      }

      return results;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['commission-grid'] });
      setBulkImportText('');
      setShowBulkImport(false);
    },
  });

  // Filter data based on search
  const filteredData = gridData.filter(row =>
    row.carrierName.toLowerCase().includes(searchTerm.toLowerCase()) ||
    row.productName.toLowerCase().includes(searchTerm.toLowerCase())
  );

  // Handle commission rate edit
  const handleRateEdit = useCallback(
    async (rowId: string, contractLevel: number, value: string) => {
      const row = gridData.find(r =>
        `${r.carrierId}-${r.productId || 'default'}` === rowId
      );

      if (!row) return;

      const numValue = parseFloat(value);
      if (isNaN(numValue) || numValue < 0 || numValue > 100) {
        setEditingCell(null);
        return;
      }

      try {
        const existingRate = row.rates[contractLevel];

        if (existingRate !== undefined) {
          // Update existing rate - we need to query for the ID first
          const { data: entries } = await compGuideService.getEntriesByProduct(row.productId!);
          const entry = entries?.find(e => e.contract_level === contractLevel);

          if (entry) {
            await updateCompRate.mutateAsync({
              id: entry.id,
              updates: {
                commission_percentage: numValue / 100,
                contract_level: contractLevel,
                carrier_id: row.carrierId,
                product_id: row.productId
              }
            });
          }
        } else {
          // Create new rate
          await createCompRate.mutateAsync({
            carrier_id: row.carrierId,
            product_id: row.productId,
            product_type: row.productType || 'term_life',
            contract_level: contractLevel,
            commission_percentage: numValue / 100,
            effective_date: new Date().toISOString().split('T')[0]
          });
        }

        queryClient.invalidateQueries({ queryKey: ['commission-grid'] });
      } catch (error) {
        console.error('Error updating rate:', error);
      } finally {
        setEditingCell(null);
      }
    },
    [gridData, createCompRate, updateCompRate, queryClient]
  );

  // Handle keyboard navigation in cells
  const handleKeyDown = useCallback(
    (e: React.KeyboardEvent) => {
      if (e.key === 'Enter' || e.key === 'Tab') {
        e.preventDefault();
        if (editingCell) {
          handleRateEdit(editingCell.rowId, editingCell.contractLevel, editingCell.value);
        }
      } else if (e.key === 'Escape') {
        setEditingCell(null);
      }
    },
    [editingCell, handleRateEdit]
  );

  // Handle quick add
  const handleQuickAdd = async () => {
    if (!quickAddForm.productName.trim()) return;

    if (quickAddForm.carrier === 'new') {
      // User needs to provide carrier name
      const carrierName = prompt('Enter new carrier name:');
      if (!carrierName?.trim()) return;

      await createCarrierWithProduct.mutateAsync({
        carrierName: carrierName.trim(),
        productName: quickAddForm.productName,
        productType: quickAddForm.productType
      });
    } else if (quickAddForm.carrier) {
      // Add to existing carrier
      await createProduct.mutateAsync({
        carrierId: quickAddForm.carrier,
        productName: quickAddForm.productName,
        productType: quickAddForm.productType
      });
    }
  };

  // Handle delete product
  const handleDeleteProduct = async (row: CommissionGridRow) => {
    if (!confirm(`Delete ${row.productName}? This will remove all commission rates for this product.`)) return;

    try {
      if (row.productId) {
        // Get all comp guide entries for this product
        const { data: entries } = await compGuideService.getEntriesByProduct(row.productId);

        // Delete each comp guide entry
        if (entries && entries.length > 0) {
          for (const entry of entries) {
            await compGuideService.deleteEntry(entry.id);
          }
        }

        // Delete the product (soft delete)
        await productService.deleteProduct(row.productId);
        queryClient.invalidateQueries({ queryKey: ['commission-grid'] });
      }
    } catch (error) {
      console.error('Delete failed:', error);
      alert('Failed to delete product. Please try again.');
    }
  };

  // Download CSV template
  const downloadTemplate = () => {
    const template = 'Carrier Name,Product Name,Product Type\nForesters,Whole Life 0-75,whole_life\nForesters,Term Life 20yr,term_life';
    const blob = new Blob([template], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'commission-import-template.csv';
    a.click();
    URL.revokeObjectURL(url);
  };

  // Loading state
  if (isLoading) {
    return (
      <div className="space-y-6">
        <Card>
          <CardContent className="p-8 text-center">
            <p className="text-muted-foreground">Loading commission data...</p>
          </CardContent>
        </Card>
      </div>
    );
  }

  // Error state
  if (error) {
    return (
      <div className="space-y-6">
        <Card>
          <CardContent className="p-8 text-center">
            <p className="text-red-500">Error loading commission data</p>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Bulk Import Section */}
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <div>
              <CardTitle>Bulk Import</CardTitle>
              <CardDescription>
                Quickly add multiple carriers and products at once
              </CardDescription>
            </div>
            <div className="flex gap-2">
              <Button variant="outline" size="sm" onClick={downloadTemplate}>
                <Download className="h-4 w-4 mr-2" />
                Template
              </Button>
              <Button
                variant="outline"
                size="sm"
                onClick={() => setShowBulkImport(!showBulkImport)}
              >
                <Upload className="h-4 w-4 mr-2" />
                {showBulkImport ? 'Hide' : 'Show'} Import
              </Button>
            </div>
          </div>
        </CardHeader>
        {showBulkImport && (
          <CardContent>
            <div className="space-y-4">
              <div>
                <label className="text-sm font-medium mb-2 block">
                  Paste CSV data (Carrier Name, Product Name, Product Type)
                </label>
                <textarea
                  value={bulkImportText}
                  onChange={(e) => setBulkImportText(e.target.value)}
                  placeholder="Foresters,Whole Life 0-75,whole_life&#10;Foresters,Term Life 20yr,term_life&#10;SBLI,Universal Life,universal_life"
                  className="w-full h-32 px-3 py-2 border rounded-md font-mono text-sm"
                />
              </div>
              <Button
                onClick={() => bulkImportMutation.mutate(bulkImportText)}
                disabled={!bulkImportText.trim() || bulkImportMutation.isPending}
              >
                Import {bulkImportMutation.isPending ? 'Importing...' : ''}
              </Button>
            </div>
          </CardContent>
        )}
      </Card>

      {/* Quick Add Section */}
      <Card>
        <CardHeader>
          <CardTitle>Quick Add Product</CardTitle>
          <CardDescription>
            Add a single product to an existing or new carrier
          </CardDescription>
        </CardHeader>
        <CardContent>
          <div className="flex gap-4">
            <div className="flex-1">
              <label className="text-sm font-medium mb-2 block">Carrier</label>
              <select
                value={quickAddForm.carrier}
                onChange={(e) => setQuickAddForm({ ...quickAddForm, carrier: e.target.value })}
                className="w-full h-10 px-3 border rounded-md"
              >
                <option value="">Select carrier...</option>
                {carriers.map(carrier => (
                  <option key={carrier.id} value={carrier.id}>
                    {carrier.name}
                  </option>
                ))}
                <option value="new">+ Add New Carrier</option>
              </select>
            </div>
            <div className="flex-1">
              <label className="text-sm font-medium mb-2 block">Product Name</label>
              <Input
                type="text"
                placeholder="e.g., Whole Life 0-75"
                value={quickAddForm.productName}
                onChange={(value) => setQuickAddForm({ ...quickAddForm, productName: String(value) })}
              />
            </div>
            <div className="w-48">
              <label className="text-sm font-medium mb-2 block">Product Type</label>
              <select
                value={quickAddForm.productType}
                onChange={(e) => setQuickAddForm({ ...quickAddForm, productType: e.target.value as ProductType })}
                className="w-full h-10 px-3 border rounded-md"
              >
                {PRODUCT_TYPES.map(type => (
                  <option key={type} value={type}>
                    {type.replace('_', ' ')}
                  </option>
                ))}
              </select>
            </div>
            <div className="flex items-end">
              <Button
                onClick={handleQuickAdd}
                disabled={!quickAddForm.carrier || !quickAddForm.productName.trim()}
              >
                <Plus className="h-4 w-4 mr-2" />
                Add
              </Button>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Commission Grid */}
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <div>
              <CardTitle>Commission Rates</CardTitle>
              <CardDescription>
                Click any rate to edit. Delete button removes the entire product.
              </CardDescription>
            </div>
            <div className="relative w-80">
              <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground" />
              <Input
                type="text"
                placeholder="Search carriers or products..."
                value={searchTerm}
                onChange={(value) => setSearchTerm(String(value))}
                className="pl-9"
              />
            </div>
          </div>
        </CardHeader>
        <CardContent>
          <div className="overflow-x-auto">
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead className="w-[150px] sticky left-0 bg-background">Carrier</TableHead>
                  <TableHead className="w-[200px]">Product</TableHead>
                  {CONTRACT_LEVELS.map(level => (
                    <TableHead key={level} className="w-[80px] text-center">
                      {level}%
                    </TableHead>
                  ))}
                  <TableHead className="w-[80px] text-center">Actions</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {filteredData.map((row) => {
                  const rowId = `${row.carrierId}-${row.productId || 'default'}`;

                  return (
                    <TableRow key={rowId}>
                      <TableCell className="sticky left-0 bg-background font-medium">
                        {row.carrierName}
                      </TableCell>
                      <TableCell>
                        <div>
                          {row.productName}
                          {row.productType && (
                            <span className="ml-2 text-xs text-muted-foreground">
                              ({row.productType.replace('_', ' ')})
                            </span>
                          )}
                        </div>
                      </TableCell>
                      {CONTRACT_LEVELS.map(level => {
                        const rate = row.rates[level];
                        const isEditing = editingCell?.rowId === rowId && editingCell?.contractLevel === level;

                        return (
                          <TableCell
                            key={level}
                            className={`text-center p-1 ${!rate ? 'bg-red-50' : 'bg-green-50'}`}
                          >
                            {isEditing ? (
                              <input
                                ref={inputRef}
                                type="number"
                                step="0.01"
                                min="0"
                                max="100"
                                value={editingCell.value}
                                onChange={(e) => setEditingCell({ ...editingCell, value: e.target.value })}
                                onBlur={() => handleRateEdit(rowId, level, editingCell.value)}
                                onKeyDown={handleKeyDown}
                                className="h-8 w-full text-center px-2 border rounded"
                                autoFocus
                              />
                            ) : (
                              <div
                                className="cursor-pointer hover:bg-blue-100 px-2 py-1 rounded"
                                onClick={() => setEditingCell({
                                  rowId,
                                  contractLevel: level,
                                  value: rate ? (rate * 100).toString() : ''
                                })}
                              >
                                {rate ? `${(rate * 100).toFixed(1)}%` : '-'}
                              </div>
                            )}
                          </TableCell>
                        );
                      })}
                      <TableCell className="text-center">
                        <Button
                          size="sm"
                          variant="ghost"
                          onClick={() => handleDeleteProduct(row)}
                        >
                          <Trash2 className="h-4 w-4 text-red-500" />
                        </Button>
                      </TableCell>
                    </TableRow>
                  );
                })}
              </TableBody>
            </Table>
          </div>

          {filteredData.length === 0 && (
            <div className="text-center py-8 text-muted-foreground">
              No commission data found. Use Quick Add or Bulk Import to get started.
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  );
}

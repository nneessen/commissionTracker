// src/features/chat-bot/ChatBotPage.tsx
// Main page with tab layout for AI Chat Bot management

import { useState, useCallback, useEffect, useRef } from "react";
import {
  Bot,
  Settings,
  MessageSquare,
  Calendar,
  Activity,
  Loader2,
  CreditCard,
  Lock,
} from "lucide-react";
import { Badge } from "@/components/ui/badge";
import { cn } from "@/lib/utils";
import { toast } from "sonner";
import { useChatBotAgent, type ChatBotAgent } from "./hooks/useChatBot";
import { useUserActiveAddons } from "@/hooks/subscription";
import { ChatBotLanding } from "./components/ChatBotLanding";
import { SetupWizard } from "./components/SetupWizard";
import { SetupTab } from "./components/SetupTab";
import { ConversationsTab } from "./components/ConversationsTab";
import { AppointmentsTab } from "./components/AppointmentsTab";
import { UsageTab } from "./components/UsageTab";

type TabId = "overview" | "setup" | "conversations" | "appointments" | "usage";

// Read initial tab from URL search params (e.g., after Calendly OAuth redirect with ?tab=setup)
// NOTE: Do NOT call history.replaceState here — it triggers TanStack Router's Transitioner
// during render, breaking event handlers. URL cleanup is done in a useEffect instead.
function getInitialTab(): TabId {
  const params = new URLSearchParams(window.location.search);
  const tab = params.get("tab");
  if (
    tab === "setup" ||
    tab === "conversations" ||
    tab === "appointments" ||
    tab === "usage"
  ) {
    return tab;
  }
  return "overview";
}

function isSetupComplete(agent: ChatBotAgent): boolean {
  const closeConnected = agent.connections?.close?.connected || false;
  const calendlyConnected = agent.connections?.calendly?.connected || false;
  const hasLeadSources = (agent.autoOutreachLeadSources?.length ?? 0) > 0;
  const hasLeadStatuses = (agent.allowedLeadStatuses?.length ?? 0) > 0;
  return (
    closeConnected && calendlyConnected && hasLeadSources && hasLeadStatuses
  );
}

function getWizardDoneKey(agentId: string): string {
  return `chatbot_wizard_done_${agentId}`;
}

export function ChatBotPage() {
  const [activeTab, setActiveTab] = useState<TabId>(getInitialTab);
  const { activeAddons, isLoading: addonsLoading } = useUserActiveAddons();
  const chatBotAddon = activeAddons.find(
    (a) => a.addon?.name === "ai_chat_bot",
  );
  const hasAddon = !!chatBotAddon;
  const currentTierId = chatBotAddon?.tier_id || null;
  const { data: agent, isLoading: agentLoading } = useChatBotAgent(hasAddon);

  const isLoading = addonsLoading || (hasAddon && agentLoading);

  // Clean URL params after mount and show success toasts for OAuth callbacks
  useEffect(() => {
    const params = new URLSearchParams(window.location.search);
    if (params.get("calendar") === "connected") {
      toast.success("Calendly connected successfully!");
    } else if (params.get("error")) {
      toast.error(`Calendly connection failed: ${params.get("error")}`);
    }
    if (params.has("tab") || params.has("calendar") || params.has("error")) {
      const url = new URL(window.location.href);
      url.searchParams.delete("tab");
      url.searchParams.delete("calendar");
      url.searchParams.delete("error");
      window.history.replaceState({}, "", url.pathname + (url.search || ""));
    }
  }, []);

  // Track previous hasAddon to detect when user just subscribed
  const prevHasAddon = useRef(hasAddon);
  useEffect(() => {
    if (!prevHasAddon.current && hasAddon && agent) {
      // User just subscribed — switch to setup tab
      setActiveTab("setup");
    }
    prevHasAddon.current = hasAddon;
  }, [hasAddon, agent]);

  // Check if wizard was completed (persisted in localStorage)
  const wizardDone = agent
    ? localStorage.getItem(getWizardDoneKey(agent.id)) === "true"
    : false;

  const setupComplete = agent ? isSetupComplete(agent) : false;

  const handleWizardComplete = useCallback(() => {
    if (agent) {
      localStorage.setItem(getWizardDoneKey(agent.id), "true");
      window.location.reload();
    }
  }, [agent]);

  // Callback for when user purchases a plan — switch to setup tab
  const handlePlanActivated = useCallback(() => {
    setActiveTab("setup");
  }, []);

  // Build visible tabs based on state
  const tabs: {
    id: TabId;
    label: string;
    icon: React.ElementType;
    locked?: boolean;
  }[] = [
    { id: "overview", label: "Subscription", icon: CreditCard },
    {
      id: "setup",
      label: "Bot Configuration",
      icon: Settings,
      locked: !hasAddon,
    },
  ];

  // Only show dashboard tabs when setup is complete
  if (hasAddon && agent && (setupComplete || wizardDone)) {
    tabs.push(
      { id: "conversations", label: "Conversations", icon: MessageSquare },
      { id: "appointments", label: "Appointments", icon: Calendar },
      { id: "usage", label: "Usage", icon: Activity },
    );
  }

  // Status badge
  const statusBadge = !hasAddon ? null : !agent ? null : setupComplete ||
    wizardDone ? (
    agent.botEnabled ? (
      <Badge className="text-[9px] h-4 px-1.5 bg-emerald-100 text-emerald-700 dark:bg-emerald-900 dark:text-emerald-300">
        Active
      </Badge>
    ) : (
      <Badge
        variant="secondary"
        className="text-[9px] h-4 px-1.5 bg-zinc-100 text-zinc-600 dark:bg-zinc-800 dark:text-zinc-300"
      >
        Inactive
      </Badge>
    )
  ) : (
    <Badge className="text-[9px] h-4 px-1.5 bg-amber-100 text-amber-700 dark:bg-amber-900 dark:text-amber-300">
      Setup Required
    </Badge>
  );

  // Loading state
  if (isLoading) {
    return (
      <div className="h-[calc(100vh-4rem)] flex flex-col p-3 space-y-2.5 bg-zinc-50 dark:bg-zinc-950">
        <div className="flex items-center justify-center flex-1">
          <Loader2 className="h-6 w-6 animate-spin text-zinc-400" />
        </div>
      </div>
    );
  }

  return (
    <div className="h-[calc(100vh-4rem)] flex flex-col p-3 space-y-2.5 bg-zinc-50 dark:bg-zinc-950">
      {/* Header */}
      <div className="flex items-center justify-between bg-white dark:bg-zinc-900 rounded-lg px-3 py-2 border border-zinc-200 dark:border-zinc-800">
        <div className="flex items-center gap-2">
          <Bot className="h-4 w-4 text-zinc-900 dark:text-zinc-100" />
          <h1 className="text-sm font-semibold text-zinc-900 dark:text-zinc-100">
            AI Chat Bot
          </h1>
          {statusBadge}
        </div>
      </div>

      {/* Tabs */}
      <div className="flex items-center gap-0.5 bg-zinc-200/50 dark:bg-zinc-800/50 rounded-md p-0.5">
        {tabs.map((tab) => (
          <button
            key={tab.id}
            onClick={() => {
              if (!tab.locked) setActiveTab(tab.id);
            }}
            className={cn(
              "flex-1 flex items-center justify-center gap-1.5 px-3 py-1.5 text-[11px] font-medium rounded transition-all",
              tab.locked
                ? "text-zinc-300 dark:text-zinc-600 cursor-not-allowed"
                : activeTab === tab.id
                  ? "bg-white dark:bg-zinc-900 shadow-sm text-zinc-900 dark:text-zinc-100"
                  : "text-zinc-500 dark:text-zinc-400 hover:text-zinc-700 dark:hover:text-zinc-300",
            )}
            title={tab.locked ? "Choose a plan first" : undefined}
          >
            {tab.locked ? (
              <Lock className="h-3 w-3" />
            ) : (
              <tab.icon className="h-3 w-3" />
            )}
            <span>{tab.label}</span>
          </button>
        ))}
      </div>

      {/* Tab Content */}
      <div className="flex-1 overflow-y-auto">
        {/* Overview tab — plan selection + info */}
        {activeTab === "overview" && (
          <ChatBotLanding
            currentTierId={currentTierId}
            onPlanActivated={handlePlanActivated}
          />
        )}

        {/* Setup tab — locked, wizard, or full config */}
        {activeTab === "setup" &&
          (!hasAddon || !agent ? (
            /* Locked state */
            <div className="flex flex-col items-center justify-center py-16 px-4">
              <div className="w-12 h-12 rounded-full bg-zinc-100 dark:bg-zinc-800 flex items-center justify-center mb-3">
                <Lock className="h-5 w-5 text-zinc-400" />
              </div>
              <h3 className="text-[13px] font-semibold text-zinc-900 dark:text-zinc-100 mb-1">
                Choose a Plan First
              </h3>
              <p className="text-[11px] text-zinc-500 dark:text-zinc-400 text-center max-w-xs mb-4">
                Select a plan on the "Subscription" tab to unlock bot
                configuration. You can start with the free plan — no credit card
                required.
              </p>
              <button
                onClick={() => setActiveTab("overview")}
                className="text-[11px] font-medium text-blue-600 dark:text-blue-400 hover:underline"
              >
                Go to Subscription
              </button>
            </div>
          ) : !(setupComplete || wizardDone) ? (
            /* Wizard — step-by-step configuration */
            <SetupWizard agent={agent} onComplete={handleWizardComplete} />
          ) : (
            /* Full config dashboard */
            <SetupTab />
          ))}

        {/* Dashboard tabs — only rendered when visible */}
        {activeTab === "conversations" && <ConversationsTab />}
        {activeTab === "appointments" && <AppointmentsTab />}
        {activeTab === "usage" && <UsageTab />}
      </div>
    </div>
  );
}
